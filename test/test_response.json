[
  {
    "rendered_body": "çœç•¥",
    "body": "# ç›®çš„\nãƒšã‚¢ãƒªãƒ³ã‚°æ™‚ã«PINã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›ãŒå¿…è¦ã¨ãªã‚‹å ´åˆã«ãŠã„ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã« (ãƒ¦ãƒ¼ã‚¶ã«ã‚ˆã‚‹æ‰‹å…¥åŠ›ãªã—ã§) Bluetoothã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã†æ–¹æ³•ã‚’ã“ã“ã«ãƒ¡ãƒ¢ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚\n\n# æ¦‚è¦\nå¤§ã¾ã‹ã«æ›¸ãã¨ä»¥ä¸‹ã®æ‰‹é †ã‚’è¡Œã†ã“ã¨ã¨ãªã‚Šã¾ã™ã€‚\n\n1. NFCã‚„USBãªã©ã‚’çµŒç”±ã—ã¦ã€å‘¨è¾ºæ©Ÿå™¨ã®BDã‚¢ãƒ‰ãƒ¬ã‚¹ (MACã‚¢ãƒ‰ãƒ¬ã‚¹) ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å—ä¿¡ã™ã‚‹ã€‚\n2. BDã‚¢ãƒ‰ãƒ¬ã‚¹ã‚ˆã‚Šã€ãã®å‘¨è¾ºæ©Ÿå™¨ã® `BluetoothDevice` ã‚’ç”Ÿæˆã™ã‚‹ã€‚\n3. `BluetoothDevice.ACTION_PAIRING_REQUEST` ã‚’å—ä¿¡ã™ã‚‹BroadcastReceiverã‚’ç™»éŒ²ã™ã‚‹ã€‚\n4. `BluetoothDevice#createBond()` ã«ã‚ˆã£ã¦ãƒšã‚¢ãƒªãƒ³ã‚°è¦æ±‚ã‚’è¡Œã†ã€‚\n5. `BluetoothDevice#setPin()` ã«ã‚ˆã£ã¦PINã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã€‚\n\n# æ‰‹é †\nãã‚Œã§ã¯å„æ‰‹é †ã”ã¨ã«èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚\n\n## 1. å‘¨è¾ºæ©Ÿå™¨ã®BDã‚¢ãƒ‰ãƒ¬ã‚¹ã¨PINã‚³ãƒ¼ãƒ‰ã‚’å—ä¿¡\nã¾ãšæœ€åˆã«ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã„ãŸã„å‘¨è¾ºæ©Ÿå™¨ã®PINã‚³ãƒ¼ãƒ‰ (ã¨BDã‚¢ãƒ‰ãƒ¬ã‚¹) ã‚’æ‰‹ã«å…¥ã‚Œã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚\nã“ã‚Œã‚’è¡Œã†æ‰‹æ®µã«æ±ºã¾ã‚Šã¯ãªã„ã®ã§ã™ãŒã€å¤§æŠµã¯NFCçµŒç”±ã§è¡Œã‚ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚\nã“ã®æ‰‹é †ã«é–¢ã—ã¦ã¯ã“ã“ã§ã¯è©³ã—ãã¯è§¦ã‚Œã¾ã›ã‚“ã€‚  \n(ã‚‚ã—ãã¯æ©Ÿå™¨ã«ã‚ˆã£ã¦ã¯PINã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚’ä¿ƒã•ã‚Œã‚‹ã‚‚ã®ã®ã€ã‚³ãƒ¼ãƒ‰ãŒå›ºå®šã®å€¤ (`0000` ã‚„ `1234`) ã§ã‚ã‚‹å ´åˆãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚)\n\n## 2. å‘¨è¾ºæ©Ÿå™¨ã®BluetoothDeviceã‚’å–å¾—\nä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚ˆã£ã¦æ‰‹é †ã¯ç•°ãªã‚‹ã¨ã¯æ€ã„ã¾ã™ãŒã€å…ˆç¨‹ã®æ‰‹é †ã§å–å¾—ã—ãŸBDã‚¢ãƒ‰ãƒ¬ã‚¹ (MACã‚¢ãƒ‰ãƒ¬ã‚¹) ã‚’å…ƒã« `BluetoothDevice` ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚\n\nAndroidã®æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯\n`BluetoothAdapter#getRemoteDevice(address: String): BluetoothDevice`\nã‚’ä½¿ãˆã°ã„ã„ã‹ã¨æ€ã„ã¾ã™ã€‚  \n[RxAndroidBle](https://github.com/Polidea/RxAndroidBle)ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯\n`RxBleClient#getBleDevice(macAddress: String): RxBleDevice`\nâ†’ `RxBleDevice#getBluetoothDevice(): BluetoothDevice`\nã§å–å¾—ã§ãã¾ã™ã€‚\n\nã¾ãŸã€å‘¨è¾ºæ©Ÿå™¨ã®BDã‚¢ãƒ‰ãƒ¬ã‚¹ (MACã‚¢ãƒ‰ãƒ¬ã‚¹) ãŒãªã„å ´åˆã¯ã€ã‚¹ã‚­ãƒ£ãƒ³ã‚’æ›ã‘ã‚‹ãªã‚Šã—ã¦ `BluetoothDevice` ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚\n\n## 3. BroadcastReceiverã®ç™»éŒ²\nBluetoothã®ãƒšã‚¢ãƒªãƒ³ã‚°è¦æ±‚ãŒè¡Œã‚ã‚ŒãŸéš›ã« `BluetoothDevice.ACTION_PAIRING_REQUEST` ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é£›ã‚“ã§æ¥ã‚‹ã®ã§ã€ã“ã‚Œã‚’è³¼èª­ã™ã‚‹BroadcastReceiverã‚’ç™»éŒ²ã—ã¾ã™ã€‚\n\nã©ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã‚‚ã„ã„ã®ã§ã™ãŒã€ç§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚\n\n```Kotlin\npackage net.aridai.pairingapp\n\nimport android.bluetooth.BluetoothDevice\nimport android.content.Intent\nimport android.content.IntentFilter\nimport android.os.Bundle\nimport androidx.appcompat.app.AppCompatActivity\nimport com.polidea.rxandroidble2.RxBleClient\nimport com.polidea.rxandroidble2.RxBleDevice\nimport kotlinx.android.synthetic.main.main_activity.*\nimport org.koin.android.ext.android.inject\n\n//  Activityã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚\n//  ä¸€éƒ¨çœç•¥ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã€‚\nclass MainActivity : AppCompatActivity() {\n\n    //  ç§ã¯RxAndroidBleã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚\n    private val bleClient: RxBleClient by inject()\n\n    //  IntentFilterã®è¨­å®šã§ã™ã€‚\n    //  å„ªå…ˆåº¦ã‚’æœ€å¤§ã®999 (SYSTEM_HIGH_PRIORITY - 1) ã«ã—ã¦ã„ã¾ã™ã€‚\n    private val pairingRequestIntentFilter: IntentFilter by lazy {\n        IntentFilter(BluetoothDevice.ACTION_PAIRING_REQUEST).also {\n            it.priority = IntentFilter.SYSTEM_HIGH_PRIORITY - 1\n        }\n    }\n\n    //  BroadcastReceiverã§ã™ã€‚\n    //  ã€ŒPairingBroadcastReceiverã€ã¯ç§ãŒå®šç¾©ã—ãŸã‚¯ãƒ©ã‚¹ã§ã™ã€‚\n    private var pairingBroadcastReceiver: PairingBroadcastReceiver? = null\n\n    override fun onCreate(savedInstanceState: Bundle?) {\n        //  çœç•¥...\n    }\n\n    override fun onResume() {\n        super.onResume()\n\n        //  ã“ã“ã§BroadcastReceiverã®ç™»éŒ²ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚\n        this.pairingBroadcastReceiver = PairingBroadcastReceiver()\n        this.registerReceiver(this.pairingBroadcastReceiver, this.pairingRequestIntentFilter)\n    }\n\n    override fun onPause() {\n        super.onPause()\n\n        //  ã“ã“ã§BroadcastReceiverã®ç™»éŒ²è§£é™¤ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚\n        this.unregisterReceiver(this.pairingBroadcastReceiver)\n        this.pairingBroadcastReceiver = null\n    }\n\n    //  ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚\n    private fun pair(address: String, pin: ByteArray) {\n        //  ç§ã¯RxAndroidBleã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã“ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚\n        val bluetoothDevice = this.bleClient.getBleDevice(address).bluetoothDevice\n        bluetoothDevice.createBond()\n\n        //  Androidæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§è¡Œã†å ´åˆã¯ BluetoothAdapter#getRemoteDevice(address) ã‚’ä½¿ã†ã¨ã„ã„ã‹ã¨æ€ã„ã¾ã™ã€‚\n    }\n}\n\n```\n\n## 4. ãƒšã‚¢ãƒªãƒ³ã‚°ã®è¦æ±‚\nä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã§ã™ã€‚  \n`BluetoothDevice` ã‚’å–å¾—ã—ã¦ `createBond()` ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã€‚\n\n```Kotlin\n//  RxAndroidBleã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆ\nprivate fun pair(address: String, pin: ByteArray) {\n    this.pairingBroadcastReceiver!!.pin = pin\n    val bluetoothDevice = this.bleClient.getBleDevice(address).bluetoothDevice\n    bluetoothDevice.createBond()\n}\n```\n\n```Kotlin\n//  Androidæ¨™æº–ã§ã‚„ã‚‹å ´åˆ\n//  (this.adapter: BluetoothAdapter)\nprivate fun pair(address: String, pin: ByteArray) {\n    this.pairingBroadcastReceiver!!.pin = pin\n    val bluetoothDevice = this.adapter.getRemoteDevice(address)\n    bluetoothDevice.createBond()\n}\n```\n\n## 5. PINã‚³ãƒ¼ãƒ‰ã®å…¥åŠ›\næ­£å¸¸ã«ãƒšã‚¢ãƒªãƒ³ã‚°è¦æ±‚ãŒã•ã‚ŒãŸå ´åˆã€BroadcastReceiverãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã¾ã™ã®ã§ã€ãã“ã§PINã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«å…¥åŠ›ã—ã¾ã™ã€‚\n\n```Kotlin\npackage net.aridai.pairingapp\n\nimport android.bluetooth.BluetoothDevice\nimport android.content.BroadcastReceiver\nimport android.content.Context\nimport android.content.Intent\n\nclass PairingBroadcastReceiver : BroadcastReceiver() {\n\n    //  PINã‚³ãƒ¼ãƒ‰ã®å—ã‘æ¸¡ã—å£\n    //  (ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãªã®ã§é›‘ã§ã‚‚æ°—ã«ã—ãªã„ã§ã­â™¡)\n    var pin: ByteArray? = null\n\n    override fun onReceive(context: Context?, intent: Intent?) {\n        if (intent == null) return\n\n        if (intent.action == BluetoothDevice.ACTION_PAIRING_REQUEST) {\n            val device = intent.getParcelableExtra\u003cBluetoothDevice\u003e(BluetoothDevice.EXTRA_DEVICE)!!\n            val pin = this.pin!!\n\n            device.setPin(pin)\n\n            //  ä»–ã®BroadcastReceiverã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé£›ã‚“ã§ã„ã‹ãªãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚\n            //  ã“ã‚Œã‚’å‘¼ã°ãªã„ã¨ã‚·ã‚¹ãƒ†ãƒ ã®ãƒšã‚¢ãƒªãƒ³ã‚°è¦æ±‚é€šçŸ¥ãŒå‡ºã¦ãã¦ã—ã¾ã†ã€‚\n            this.abortBroadcast()\n        }\n    }\n}\n\n```\n\nã‚³ãƒ¼ãƒ‰ä¸­ã§ `BroadcastReceiver#abortBroadcast()` ã‚’å‘¼ã‚“ã§ã„ã¾ã™ãŒã€ã“ã‚Œã‚’å‘¼ã°ãªã„ã¨Androidã®ã‚·ã‚¹ãƒ†ãƒ ã®é€šçŸ¥ãŒå‡ºã¦ãã¦ã—ã¾ã„ã¾ã™ã€‚ \n\n![ãƒ˜ã‚šã‚¢ãƒªãƒ³ã‚¯ã‚™é€šçŸ¥.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/341119/6f4bbed3-ef0b-f1e2-169c-0ae17ab9b1f4.png)\n\nã¾ãŸã€PINã‚³ãƒ¼ãƒ‰ã®å—ã‘æ¸¡ã—ã« `PairingBroadcastReceiver#pin` ã‚’Activityå´ã‹ã‚‰ã‚»ãƒƒãƒˆã•ã›ã¦ã‚„ã£ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯ã‚‚ã£ã¨ã¡ã‚ƒã‚“ã¨ã‚„ã‚Šã¾ã—ã‚‡ã†ã€‚\n\n```kotlin\n//  â€» ä¾‹ãˆã°ã®å®Ÿè£…ä¾‹ã§ã™ã€‚\n//  ã“ã‚“ãªã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’åˆ‡ã£ã¦ã€\ninterface PairingPinProvider {\n    fun providePin(address: String): ByteArray?\n}\n\n//  BroadcastReceiverè³¼èª­å…ƒã«å®Ÿè£…ã•ã›ã¦ã€\nclass MainActivity : AppCompatActivity(), PairingPinProvider {\n    //  ã„ã‚ã„ã‚ã¨çœç•¥...\n\n    override fun providePin(address: String): ByteArray? {\n        //  ã¡ã‚ƒã‚“ã¨å®Ÿè£…\n    }\n}\n\n//  ç‰¹å®šã®Activityã˜ã‚ƒãªãã¦ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜ã•ã›ã‚‹ã€‚\noverride fun onReceive(context: Context?, intent: Intent?) {\n    if (context !is PairingPinProvider || intent == null) return\n    //  çœç•¥...\n    val pin = context.providePin(device.address) ?: throw IllegalStateException(\"ãƒšã‚¢ãƒªãƒ³ã‚°è¦æ±‚ã—ãŸãã›ã«PINã­ã‡ã˜ã‚ƒã‚“ww\")\n}\n```\n\n# ãã®ä»–\n\nãƒšã‚¢ãƒªãƒ³ã‚° (ãƒœãƒ³ãƒ‡ã‚£ãƒ³ã‚°) ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã“ã¨ã‚’çŸ¥ã‚‹ã«ã¯ `BluetoothDevice.ACTION_BOND_STATE_CHANGED` ã®BroadcastReceiverã‚’ä½¿ã†ã¨ã„ã„ã§ã—ã‚‡ã†ã€‚\n\n```Kotlin\npackage net.aridai.pairingapp\n\nimport android.bluetooth.BluetoothDevice\nimport android.content.BroadcastReceiver\nimport android.content.Context\nimport android.content.Intent\n\nclass BondStateChangedBroadcastReceiver : BroadcastReceiver() {\n\n    override fun onReceive(context: Context?, intent: Intent?) {\n        if (context !is BondStateChangedListener || intent == null) return\n\n        if (intent.action == BluetoothDevice.ACTION_BOND_STATE_CHANGED) {\n            val device = intent.getParcelableExtra\u003cBluetoothDevice\u003e(BluetoothDevice.EXTRA_DEVICE)!!\n            val prevBondState = intent.getIntExtra(BluetoothDevice.EXTRA_PREVIOUS_BOND_STATE, -1)\n            val bondState = intent.getIntExtra(BluetoothDevice.EXTRA_BOND_STATE, -1)\n\n            context.onBondStateChanged(device, prevBondState, bondState)\n        }\n    }\n\n    interface BondStateChangedListener {\n        fun onBondStateChanged(device: BluetoothDevice, prevState: Int, currentState: Int)\n    }\n}\n\n```\n\nã¾ãŸ `AndroidManifest.xml` ã«ã¡ã‚ƒã‚“ã¨ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ›¸ãã¾ã—ã‚‡ã†ã€‚\n\n```xml\n    \u003cuses-permission android:name=\"android.permission.BLUETOOTH\" /\u003e\n    \u003cuses-permission android:name=\"android.permission.BLUETOOTH_ADMIN\" /\u003e\n\n    \u003cuses-feature\n        android:name=\"android.hardware.bluetooth_le\"\n        android:required=\"true\" /\u003e\n```\n\n# å‚è€ƒ\n\n* [BluetoothDevice | Android Developers](https://developer.android.com/reference/android/bluetooth/BluetoothDevice)\n* [BluetoothAdapter |Â Android Developers](https://developer.android.com/reference/android/bluetooth/BluetoothAdapter.html#getRemoteDevice(java.lang.String))\n* [android - Broadcast receiver highest priority not working - Stack Overflow](https://stackoverflow.com/a/27653789)\n",
    "coediting": false,
    "comments_count": 0,
    "created_at": "2020-02-01T08:27:34+09:00",
    "group": null,
    "id": "cf9a7627c41bf7c13c80",
    "likes_count": 0,
    "private": false,
    "reactions_count": 0,
    "tags": [
      {
        "name": "Android",
        "versions": []
      },
      {
        "name": "bluetooth",
        "versions": []
      }
    ],
    "title": "ã€Androidã€‘ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«Bluetoothã®ãƒšã‚¢ãƒªãƒ³ã‚°ã‚’è¡Œã†æ–¹æ³•ã€Bluetoothã€‘",
    "updated_at": "2020-02-01T11:56:34+09:00",
    "url": "https://qiita.com/aridai/items/cf9a7627c41bf7c13c80",
    "user": {
      "description": "Androidã¨WPFã‚’æ›¸ãğŸœã§ã™ã€‚\r\nKotlinã‹ã‚ã„ã„ã‚ˆKotlinğŸ¤",
      "facebook_id": "",
      "followees_count": 0,
      "followers_count": 1,
      "github_login_name": null,
      "id": "aridai",
      "items_count": 1,
      "linkedin_id": "",
      "location": "",
      "name": "",
      "organization": "",
      "permanent_id": 341119,
      "profile_image_url": "https://s3-ap-northeast-1.amazonaws.com/qiita-image-store/0/341119/d45dcff0ceabdf78fa082d872fea08492157dbef/large.png?1581068618",
      "team_only": false,
      "twitter_screen_name": "aridai_net",
      "website_url": ""
    },
    "page_views_count": null
  }
]
